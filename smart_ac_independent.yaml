blueprint:
  name: Smart AC Control Independent (v6.4 - Mode Control Toggle)
  description: >
    Automatically adjusts AC based on individual floor temperatures. Each floor operates independently.
    HVAC modes, presets, and defrost settings are all per-unit, allowing different configurations for each AC.
    Includes passive defrost protection, optional active defrost intervention, dynamic hysteresis
    that scales based on outdoor temperature, and per-unit mode control toggle (when disabled, only
    sets temperature target like floor heaters).
  domain: automation
  source_url: https://github.com/danielcherubini/Home_Assistant_Blueprints/blob/main/smart_ac_independent.yaml
  input:
    core_settings:
      name: Core Settings
      icon: mdi:cog
      input:
        comfort_temperature:
          name: Comfort Temperature Entity
          description: The input_number entity that controls the target comfort temperature.
          selector:
            entity:
              domain:
              - input_number
              multiple: false
          default: input_number.comfort_temp
        heating_hysteresis:
          name: Heating Hysteresis (Â°C)
          description: Temperature difference before heating is activated.
          selector:
            number:
              min: -10.0
              max: 10.0
              step: 0.5
              mode: slider
          default: 0.8
        cooling_hysteresis:
          name: Cooling Hysteresis (Â°C)
          description: Temperature difference before cooling is activated.
          selector:
            number:
              min: -10.0
              max: 10.0
              step: 0.5
              mode: slider
          default: 1.0
        defrost_threshold_temp:
          name: Passive Defrost Protection Threshold (Â°C)
          description: >
            When coil temp falls below this, passive defrost protection activates (prevents heatâ†’fan_only switching).
            For Nordic/cold-climate units like Panasonic HZ, use -5Â°C to -10Â°C since these units have robust built-in defrost.
          selector:
            number:
              min: -15.0
              max: 10.0
              step: 0.5
              mode: slider
              unit_of_measurement: "Â°C"
          default: -5.0
        active_defrost_coil_threshold:
          name: Active Defrost Coil Threshold (Â°C)
          description: Force defrost when coil temp drops below this for the specified duration. Recommended -15Â°C.
          selector:
            number:
              min: -25.0
              max: 0.0
              step: 1.0
              mode: slider
              unit_of_measurement: "Â°C"
          default: -15.0
        active_defrost_trigger_minutes:
          name: Active Defrost Trigger Duration (minutes)
          description: How long the coil must stay below threshold before forcing a defrost cycle.
          selector:
            number:
              min: 5
              max: 60
              step: 5
              mode: slider
              unit_of_measurement: "min"
          default: 30
        active_defrost_cycle_minutes:
          name: Active Defrost Cycle Duration (minutes)
          description: How long to run in cooling mode to defrost the coil.
          selector:
            number:
              min: 5
              max: 20
              step: 1
              mode: slider
              unit_of_measurement: "min"
          default: 10
        active_defrost_cool_temp:
          name: Active Defrost Cooling Temperature (Â°C)
          description: Target temperature when running the defrost cooling cycle.
          selector:
            number:
              min: 10.0
              max: 20.0
              step: 1.0
              mode: slider
              unit_of_measurement: "Â°C"
          default: 16.0
        weather_entity:
          name: Weather Entity
          description: Used for outdoor temperature in dynamic hysteresis calculation.
          default: ""
          selector:
            entity:
              domain: weather
        dynamic_hysteresis_enabled:
          name: Enable Dynamic Hysteresis
          description: Scale hysteresis based on outdoor temperature (requires weather entity).
          default: false
          selector:
            boolean:
        hysteresis_mild_temp:
          name: Mild Temperature Threshold (Â°C)
          description: Above this outdoor temp, use minimum (tightest) hysteresis.
          default: 10.0
          selector:
            number:
              min: 0.0
              max: 25.0
              step: 1.0
              unit_of_measurement: "Â°C"
        hysteresis_extreme_temp:
          name: Extreme Temperature Threshold (Â°C)
          description: Below this outdoor temp, use maximum (widest) hysteresis.
          default: -15.0
          selector:
            number:
              min: -30.0
              max: 5.0
              step: 1.0
              unit_of_measurement: "Â°C"
        heating_hysteresis_min:
          name: Heating Hysteresis Min (Â°C)
          description: Tightest deadband - used when outdoor temp is mild.
          default: 0.5
          selector:
            number:
              min: 0.1
              max: 2.0
              step: 0.1
              unit_of_measurement: "Â°C"
        heating_hysteresis_max:
          name: Heating Hysteresis Max (Â°C)
          description: Widest deadband - used when outdoor temp is extreme cold.
          default: 1.5
          selector:
            number:
              min: 0.5
              max: 5.0
              step: 0.1
              unit_of_measurement: "Â°C"
        cooling_hysteresis_min:
          name: Cooling Hysteresis Min (Â°C)
          description: Tightest deadband - used when outdoor temp is mild.
          default: 0.5
          selector:
            number:
              min: 0.1
              max: 2.0
              step: 0.1
              unit_of_measurement: "Â°C"
        cooling_hysteresis_max:
          name: Cooling Hysteresis Max (Â°C)
          description: Widest deadband - used when outdoor temp is extreme hot.
          default: 2.0
          selector:
            number:
              min: 0.5
              max: 5.0
              step: 0.1
              unit_of_measurement: "Â°C"
    first_floor:
      name: 1st Floor
      icon: mdi:home-floor-1
      input:
        first_floor_heating:
          name: First Floor Heating Entity
          description: The climate entity for the first floor heating.
          selector:
            entity:
              domain:
              - climate
              multiple: false
          default: ""
        first_floor_heating_offset:
          name: First Floor Heating Offset (Â°C)
          description: Temperature offset for first floor heating relative to comfort temp.
          selector:
            number:
              min: -10.0
              max: 10.0
              step: 0.5
              mode: slider
          default: -7.0
    second_floor:
      name: 2nd Floor
      icon: mdi:home-floor-2
      input:
        second_floor_ac:
          name: 2nd Floor AC Entity
          description: The climate entity for the 2nd floor.
          selector:
            entity:
              domain:
              - climate
              multiple: false
        second_floor_temp_sensor:
          name: 2nd Floor Temperature Sensor
          description: The temperature sensor for the 2nd floor.
          selector:
            entity:
              domain:
              - sensor
              device_class:
              - temperature
              multiple: false
        second_floor_current_hvac_mode_helper:
          name: 2nd Floor AC Current HVAC Mode Helper
          description: Helper entity (input_text) to store the current HVAC mode of the
            2nd floor AC unit.
          selector:
            entity:
              domain:
              - input_text
              multiple: false
          default: input_text.second_floor_ac_hvac_mode
        second_floor_temperature_difference:
          name: 2nd Floor Temperature Difference (Â°C)
          description: Temperature difference for the 2nd floor target relative to comfort
            temp.
          selector:
            number:
              min: -10.0
              max: 10.0
              step: 0.5
              mode: slider
          default: 0.0
        second_floor_mode_control:
          name: 2nd Floor Mode Control
          description: >
            When enabled, automation controls HVAC mode, preset, and temperature.
            When disabled, only sets temperature target (like floor heaters).
          selector:
            boolean:
          default: true
        bathroom_floor_heating:
          name: Bathroom Floor Heating Entity
          description: The climate entity for the bathroom floor heating.
          selector:
            entity:
              domain:
              - climate
              multiple: false
          default: ""
        bathroom_floor_heating_offset:
          name: Bathroom Floor Heating Offset (Â°C)
          description: Temperature offset for bathroom floor heating relative to comfort temp.
          selector:
            number:
              min: -10.0
              max: 10.0
              step: 0.5
              mode: slider
          default: -1.0
        second_floor_outdoor_temp_sensor:
          name: 2nd Floor Outdoor Temperature Sensor
          description: External temperature sensor on the 2nd floor heat pump unit. Used for defrost protection.
          default: ""
          selector:
            entity:
              domain:
              - sensor
              device_class:
              - temperature
              multiple: false
        second_floor_defrost_protection:
          name: 2nd Floor Passive Defrost Protection
          description: >
            Prevents heatâ†’fan_only switching when coil temp is below threshold.
            Enable this for units that work hard (2nd floor heats upper floors via stack effect).
          selector:
            boolean:
          default: true
        second_floor_active_defrost:
          name: 2nd Floor Active Defrost Intervention
          description: >
            Forces a cooling cycle when coil stays too cold for too long.
            Enable this if built-in defrost isn't keeping up with severe icing conditions.
          selector:
            boolean:
          default: false
        second_floor_comfort_mode:
          name: 2nd Floor Comfort Mode (HVAC)
          description: The HVAC mode to use when 2nd floor is in the comfort zone.
          selector:
            select:
              options:
              - auto
              - heat_cool
              - cool
              - heat
              - fan_only
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: heat_cool
        second_floor_heat_mode:
          name: 2nd Floor Heat Mode (HVAC)
          description: The HVAC mode to use when 2nd floor needs heating.
          selector:
            select:
              options:
              - auto
              - heat_cool
              - cool
              - heat
              - fan_only
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: heat_cool
        second_floor_cool_mode:
          name: 2nd Floor Cool Mode (HVAC)
          description: The HVAC mode to use when 2nd floor needs cooling.
          selector:
            select:
              options:
              - auto
              - heat_cool
              - cool
              - heat
              - fan_only
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: cool
        second_floor_comfort_preset:
          name: 2nd Floor Comfort Preset
          description: The preset to use when 2nd floor is in the comfort zone.
          selector:
            select:
              options:
              - Normal
              - Powerful
              - Quiet
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: Normal
        second_floor_heat_preset:
          name: 2nd Floor Heat Preset
          description: The preset to use when 2nd floor needs heating.
          selector:
            select:
              options:
              - Normal
              - Powerful
              - Quiet
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: Normal
        second_floor_cool_preset:
          name: 2nd Floor Cool Preset
          description: The preset to use when 2nd floor needs cooling.
          selector:
            select:
              options:
              - Normal
              - Powerful
              - Quiet
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: Normal
    third_floor:
      name: 3rd Floor
      icon: mdi:home-floor-2
      input:
        dining_room_heating:
          name: Dining Room Heating Entity
          description: The climate entity for the dining room heating.
          selector:
            entity:
              domain:
              - climate
              multiple: false
          default: ""
        dining_room_heating_offset:
          name: Dining Room Heating Offset (Â°C)
          description: Temperature offset for dining room heating relative to comfort temp.
          selector:
            number:
              min: -10.0
              max: 10.0
              step: 0.5
              mode: slider
          default: 0.0
    fourth_floor:
      name: 4th Floor
      icon: mdi:home-floor-3
      input:
        fourth_floor_ac:
          name: 4th Floor AC Entity
          description: The climate entity for the 4th floor.
          selector:
            entity:
              domain:
              - climate
              multiple: false
        fourth_floor_temp_sensor:
          name: 4th Floor Temperature Sensor
          description: The temperature sensor for the 4th floor.
          selector:
            entity:
              domain:
              - sensor
              device_class:
              - temperature
              multiple: false
        fourth_floor_temperature_difference:
          name: 4th Floor Temperature Difference (Â°C)
          description: Temperature difference for the 4th floor target relative to comfort
            temp.
          selector:
            number:
              min: -10.0
              max: 10.0
              step: 0.5
              mode: slider
          default: -1.5
        fourth_floor_mode_control:
          name: 4th Floor Mode Control
          description: >
            When enabled, automation controls HVAC mode, preset, and temperature.
            When disabled, only sets temperature target (like floor heaters).
          selector:
            boolean:
          default: true
        fourth_floor_current_hvac_mode_helper:
          name: 4th Floor AC Current HVAC Mode Helper
          description: Helper entity (input_text) to store the current HVAC mode of the
            4th floor AC unit.
          selector:
            entity:
              domain:
              - input_text
              multiple: false
          default: input_text.fourth_floor_ac_hvac_mode
        fourth_floor_outdoor_temp_sensor:
          name: 4th Floor Outdoor Temperature Sensor
          description: External temperature sensor on the 4th floor heat pump unit. Used for defrost protection.
          default: ""
          selector:
            entity:
              domain:
              - sensor
              device_class:
              - temperature
              multiple: false
        fourth_floor_defrost_protection:
          name: 4th Floor Passive Defrost Protection
          description: >
            Prevents heatâ†’fan_only switching when coil temp is below threshold.
            Consider disabling for units that don't work hard (4th floor gets free heat from below).
          selector:
            boolean:
          default: false
        fourth_floor_active_defrost:
          name: 4th Floor Active Defrost Intervention
          description: >
            Forces a cooling cycle when coil stays too cold for too long.
            Usually not needed for 4th floor as it rarely runs hard enough to ice up.
          selector:
            boolean:
          default: false
        fourth_floor_comfort_mode:
          name: 4th Floor Comfort Mode (HVAC)
          description: The HVAC mode to use when 4th floor is in the comfort zone.
          selector:
            select:
              options:
              - auto
              - heat_cool
              - cool
              - heat
              - fan_only
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: fan_only
        fourth_floor_heat_mode:
          name: 4th Floor Heat Mode (HVAC)
          description: The HVAC mode to use when 4th floor needs heating.
          selector:
            select:
              options:
              - auto
              - heat_cool
              - cool
              - heat
              - fan_only
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: heat
        fourth_floor_cool_mode:
          name: 4th Floor Cool Mode (HVAC)
          description: The HVAC mode to use when 4th floor needs cooling.
          selector:
            select:
              options:
              - auto
              - heat_cool
              - cool
              - heat
              - fan_only
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: cool
        fourth_floor_comfort_preset:
          name: 4th Floor Comfort Preset
          description: The preset to use when 4th floor is in the comfort zone.
          selector:
            select:
              options:
              - Normal
              - Powerful
              - Quiet
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: Normal
        fourth_floor_heat_preset:
          name: 4th Floor Heat Preset
          description: The preset to use when 4th floor needs heating.
          selector:
            select:
              options:
              - Normal
              - Powerful
              - Quiet
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: Normal
        fourth_floor_cool_preset:
          name: 4th Floor Cool Preset
          description: The preset to use when 4th floor needs cooling.
          selector:
            select:
              options:
              - Normal
              - Powerful
              - Quiet
              - 'off'
              sort: false
              custom_value: false
              multiple: false
          default: Normal
    optional_settings:
      name: Optional Settings
      icon: mdi:bell-outline
      collapsed: true
      input:
        notification_device:
          name: Notification Device (Optional)
          description: Mobile device to receive notifications when HVAC mode changes
          selector:
            device:
              filter:
              - integration: mobile_app
        dashboard_url:
          name: Dashboard URL (Optional)
          description: URL path to navigate to when notification is clicked (e.g., /lovelace/climate)
          default: ""
          selector:
            text:
trigger:
- platform: state
  entity_id:
  - !input comfort_temperature
  - !input second_floor_temp_sensor
  - !input fourth_floor_temp_sensor
- platform: state
  entity_id: !input second_floor_outdoor_temp_sensor
  id: sf_outdoor_temp_change
- platform: state
  entity_id: !input fourth_floor_outdoor_temp_sensor
  id: ff_outdoor_temp_change
- platform: numeric_state
  entity_id: !input second_floor_outdoor_temp_sensor
  below: !input active_defrost_coil_threshold
  for:
    minutes: !input active_defrost_trigger_minutes
  id: sf_active_defrost_trigger
- platform: numeric_state
  entity_id: !input fourth_floor_outdoor_temp_sensor
  below: !input active_defrost_coil_threshold
  for:
    minutes: !input active_defrost_trigger_minutes
  id: ff_active_defrost_trigger
condition: []
mode: queued
max: 5
action:
# Handle active defrost triggers first - these take priority
- choose:
  - conditions:
    - condition: trigger
      id: sf_active_defrost_trigger
    - condition: template
      value_template: "{{ is_state_attr('automation.this', 'current', 0) or true }}"
    sequence:
    - variables:
        var_sf_active_defrost_enabled: !input second_floor_active_defrost
        var_active_defrost_cycle_minutes: !input active_defrost_cycle_minutes
        var_active_defrost_cool_temp: !input active_defrost_cool_temp
        var_sf_outdoor_sensor_id: !input second_floor_outdoor_temp_sensor
        second_floor_ac_entity: !input second_floor_ac
        var_sf_hvac_mode_helper_id: !input second_floor_current_hvac_mode_helper
        var_sf_heat_mode: !input second_floor_heat_mode
        var_notification_device: !input notification_device
        var_dashboard_url: !input dashboard_url
    - condition: template
      value_template: "{{ var_sf_active_defrost_enabled }}"
      alias: "Check if 2nd floor active defrost is enabled"
    - if:
      - condition: template
        value_template: "{{ var_notification_device != '' }}"
      then:
      - device_id: !input notification_device
        domain: mobile_app
        type: notify
        title: "ðŸ§Š Active Defrost - 2nd Floor"
        message: "Coil temp {{ states(var_sf_outdoor_sensor_id) }}Â°C - forcing {{ var_active_defrost_cycle_minutes }} min cooling cycle"
        data:
          url: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
          clickAction: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
    - service: climate.set_temperature
      target:
        entity_id: !input second_floor_ac
      data:
        temperature: "{{ var_active_defrost_cool_temp }}"
        hvac_mode: cool
    - delay:
        minutes: "{{ var_active_defrost_cycle_minutes }}"
    - variables:
        sf_restored_mode: "{{ states(var_sf_hvac_mode_helper_id) if states(var_sf_hvac_mode_helper_id) not in ['unknown', 'unavailable', 'none', ''] else var_sf_heat_mode }}"
    - service: climate.set_hvac_mode
      target:
        entity_id: !input second_floor_ac
      data:
        hvac_mode: "{{ sf_restored_mode }}"
    - if:
      - condition: template
        value_template: "{{ var_notification_device != '' }}"
      then:
      - device_id: !input notification_device
        domain: mobile_app
        type: notify
        title: "âœ… Defrost Complete - 2nd Floor"
        message: "Defrost cycle complete, resuming {{ sf_restored_mode }} mode"
        data:
          url: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
          clickAction: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
    alias: "2nd Floor Active Defrost Cycle"
  - conditions:
    - condition: trigger
      id: ff_active_defrost_trigger
    sequence:
    - variables:
        var_ff_active_defrost_enabled: !input fourth_floor_active_defrost
        var_active_defrost_cycle_minutes: !input active_defrost_cycle_minutes
        var_active_defrost_cool_temp: !input active_defrost_cool_temp
        var_ff_outdoor_sensor_id: !input fourth_floor_outdoor_temp_sensor
        fourth_floor_ac_entity: !input fourth_floor_ac
        var_ff_hvac_mode_helper_id: !input fourth_floor_current_hvac_mode_helper
        var_ff_heat_mode: !input fourth_floor_heat_mode
        var_notification_device: !input notification_device
        var_dashboard_url: !input dashboard_url
    - condition: template
      value_template: "{{ var_ff_active_defrost_enabled }}"
      alias: "Check if 4th floor active defrost is enabled"
    - if:
      - condition: template
        value_template: "{{ var_notification_device != '' }}"
      then:
      - device_id: !input notification_device
        domain: mobile_app
        type: notify
        title: "ðŸ§Š Active Defrost - 4th Floor"
        message: "Coil temp {{ states(var_ff_outdoor_sensor_id) }}Â°C - forcing {{ var_active_defrost_cycle_minutes }} min cooling cycle"
        data:
          url: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
          clickAction: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
    - service: climate.set_temperature
      target:
        entity_id: !input fourth_floor_ac
      data:
        temperature: "{{ var_active_defrost_cool_temp }}"
        hvac_mode: cool
    - delay:
        minutes: "{{ var_active_defrost_cycle_minutes }}"
    - variables:
        ff_restored_mode: "{{ states(var_ff_hvac_mode_helper_id) if states(var_ff_hvac_mode_helper_id) not in ['unknown', 'unavailable', 'none', ''] else var_ff_heat_mode }}"
    - service: climate.set_hvac_mode
      target:
        entity_id: !input fourth_floor_ac
      data:
        hvac_mode: "{{ ff_restored_mode }}"
    - if:
      - condition: template
        value_template: "{{ var_notification_device != '' }}"
      then:
      - device_id: !input notification_device
        domain: mobile_app
        type: notify
        title: "âœ… Defrost Complete - 4th Floor"
        message: "Defrost cycle complete, resuming {{ ff_restored_mode }} mode"
        data:
          url: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
          clickAction: "{{ var_dashboard_url if var_dashboard_url != '' else '/lovelace' }}"
    alias: "4th Floor Active Defrost Cycle"
  default:
    # Continue with normal temperature-based logic
    - variables:
        # Input references
        var_comfort_temperature_id: !input comfort_temperature
        var_second_floor_temp_sensor_id: !input second_floor_temp_sensor
        var_fourth_floor_temp_sensor_id: !input fourth_floor_temp_sensor
        var_sf_hvac_mode_helper_id: !input second_floor_current_hvac_mode_helper
        var_ff_hvac_mode_helper_id: !input fourth_floor_current_hvac_mode_helper
        var_notification_device: !input notification_device
        var_dashboard_url: !input dashboard_url
        # Hysteresis settings (static fallback values)
        var_heating_hysteresis: !input heating_hysteresis
        var_cooling_hysteresis: !input cooling_hysteresis
        # Dynamic hysteresis settings
        var_weather_entity: !input weather_entity
        var_dynamic_hysteresis_enabled: !input dynamic_hysteresis_enabled
        var_hysteresis_mild_temp: !input hysteresis_mild_temp
        var_hysteresis_extreme_temp: !input hysteresis_extreme_temp
        var_heating_hysteresis_min: !input heating_hysteresis_min
        var_heating_hysteresis_max: !input heating_hysteresis_max
        var_cooling_hysteresis_min: !input cooling_hysteresis_min
        var_cooling_hysteresis_max: !input cooling_hysteresis_max
        # Calculate outdoor temp from weather entity
        weather_outdoor_temp: >
          {{ state_attr(var_weather_entity, 'temperature')|float(0) if var_weather_entity != '' else 0 }}
        # Calculate hysteresis ratio (0 = extreme cold, 1 = mild)
        hysteresis_ratio: >
          {% if not var_dynamic_hysteresis_enabled or var_weather_entity == '' %}
            0.5
          {% else %}
            {% set ratio = (weather_outdoor_temp - var_hysteresis_extreme_temp) / (var_hysteresis_mild_temp - var_hysteresis_extreme_temp) %}
            {{ [[ratio, 1] | min, 0] | max }}
          {% endif %}
        # Effective hysteresis values
        effective_heating_hysteresis: >
          {% if not var_dynamic_hysteresis_enabled or var_weather_entity == '' %}
            {{ var_heating_hysteresis }}
          {% else %}
            {{ var_heating_hysteresis_max - (hysteresis_ratio * (var_heating_hysteresis_max - var_heating_hysteresis_min)) }}
          {% endif %}
        effective_cooling_hysteresis: >
          {% if not var_dynamic_hysteresis_enabled or var_weather_entity == '' %}
            {{ var_cooling_hysteresis }}
          {% else %}
            {{ var_cooling_hysteresis_max - (hysteresis_ratio * (var_cooling_hysteresis_max - var_cooling_hysteresis_min)) }}
          {% endif %}
        var_second_floor_temp_diff: !input second_floor_temperature_difference
        var_fourth_floor_temp_diff: !input fourth_floor_temperature_difference
        var_bathroom_floor_heating_offset: !input bathroom_floor_heating_offset
        var_first_floor_heating_offset: !input first_floor_heating_offset
        var_dining_room_heating_offset: !input dining_room_heating_offset
        bathroom_floor_heating_entity: !input bathroom_floor_heating
        first_floor_heating_entity: !input first_floor_heating
        dining_room_heating_entity: !input dining_room_heating
        # Mode control per unit
        var_sf_mode_control: !input second_floor_mode_control
        var_ff_mode_control: !input fourth_floor_mode_control
        # 2nd Floor HVAC modes
        var_sf_comfort_mode: !input second_floor_comfort_mode
        var_sf_heat_mode: !input second_floor_heat_mode
        var_sf_cool_mode: !input second_floor_cool_mode
        # 2nd Floor Presets
        var_sf_comfort_preset: !input second_floor_comfort_preset
        var_sf_heat_preset: !input second_floor_heat_preset
        var_sf_cool_preset: !input second_floor_cool_preset
        # 4th Floor HVAC modes
        var_ff_comfort_mode: !input fourth_floor_comfort_mode
        var_ff_heat_mode: !input fourth_floor_heat_mode
        var_ff_cool_mode: !input fourth_floor_cool_mode
        # 4th Floor Presets
        var_ff_comfort_preset: !input fourth_floor_comfort_preset
        var_ff_heat_preset: !input fourth_floor_heat_preset
        var_ff_cool_preset: !input fourth_floor_cool_preset
        # Passive defrost protection (prevents fan_only switching) - per unit
        var_sf_defrost_enabled: !input second_floor_defrost_protection
        var_ff_defrost_enabled: !input fourth_floor_defrost_protection
        var_defrost_threshold: !input defrost_threshold_temp
        var_sf_outdoor_sensor_id: !input second_floor_outdoor_temp_sensor
        var_ff_outdoor_sensor_id: !input fourth_floor_outdoor_temp_sensor
        # Active defrost intervention (forces cooling cycle) - per unit
        var_sf_active_defrost_enabled: !input second_floor_active_defrost
        var_ff_active_defrost_enabled: !input fourth_floor_active_defrost
        var_active_defrost_coil_threshold: !input active_defrost_coil_threshold
        var_active_defrost_cycle_minutes: !input active_defrost_cycle_minutes
        var_active_defrost_cool_temp: !input active_defrost_cool_temp
        # Per-floor defrost state
        sf_outdoor_temp_available: >
          {{ var_sf_outdoor_sensor_id != '' and
             states(var_sf_outdoor_sensor_id) not in ['unknown', 'unavailable', 'none'] }}
        sf_outdoor_temp: >
          {{ states(var_sf_outdoor_sensor_id)|float(99) if sf_outdoor_temp_available else 99 }}
        sf_defrost_protection_active: >
          {{ var_sf_defrost_enabled and sf_outdoor_temp_available and sf_outdoor_temp < var_defrost_threshold }}
        ff_outdoor_temp_available: >
          {{ var_ff_outdoor_sensor_id != '' and
             states(var_ff_outdoor_sensor_id) not in ['unknown', 'unavailable', 'none'] }}
        ff_outdoor_temp: >
          {{ states(var_ff_outdoor_sensor_id)|float(99) if ff_outdoor_temp_available else 99 }}
        ff_defrost_protection_active: >
          {{ var_ff_defrost_enabled and ff_outdoor_temp_available and ff_outdoor_temp < var_defrost_threshold }}
    - if:
      - condition: template
        value_template: "{{ var_sf_mode_control }}"
      then:
      - service: input_text.set_value
        target:
          entity_id: !input second_floor_current_hvac_mode_helper
        data:
          value: >
            {% set current_mode = states(var_sf_hvac_mode_helper_id) %}
            {% set current_temp = states(var_second_floor_temp_sensor_id)|float(0) %}
            {% set base_target = states(var_comfort_temperature_id)|float(0) %}
            {% set target = base_target + var_second_floor_temp_diff|float(0) %}
            {% if current_mode == var_sf_heat_mode %}
              {% if sf_defrost_protection_active %}
                {{ var_sf_heat_mode }}
              {% elif current_temp >= target %}
                {{ var_sf_comfort_mode }}
              {% else %}
                {{ var_sf_heat_mode }}
              {% endif %}
            {% elif current_mode == var_sf_cool_mode %}
              {% if current_temp <= target %}
                {{ var_sf_comfort_mode }}
              {% else %}
                {{ var_sf_cool_mode }}
              {% endif %}
            {% else %}
              {% if current_temp < (target - effective_heating_hysteresis) %}
                {{ var_sf_heat_mode }}
              {% elif current_temp > (target + effective_cooling_hysteresis) %}
                {{ var_sf_cool_mode }}
              {% else %}
                {{ var_sf_comfort_mode }}
              {% endif %}
            {% endif %}
      alias: Determine 2nd Floor HVAC Mode (if mode control enabled)
    - if:
      - condition: template
        value_template: "{{ var_ff_mode_control }}"
      then:
      - service: input_text.set_value
        target:
          entity_id: !input fourth_floor_current_hvac_mode_helper
        data:
          value: >
            {% set current_mode = states(var_ff_hvac_mode_helper_id) %}
            {% set current_temp = states(var_fourth_floor_temp_sensor_id)|float(0) %}
            {% set base_target = states(var_comfort_temperature_id)|float(0) %}
            {% set target = base_target + var_fourth_floor_temp_diff|float(0) %}
            {% if current_mode == var_ff_heat_mode %}
              {% if ff_defrost_protection_active %}
                {{ var_ff_heat_mode }}
              {% elif current_temp >= target %}
                {{ var_ff_comfort_mode }}
              {% else %}
                {{ var_ff_heat_mode }}
              {% endif %}
            {% elif current_mode == var_ff_cool_mode %}
              {% if current_temp <= target %}
                {{ var_ff_comfort_mode }}
              {% else %}
                {{ var_ff_cool_mode }}
              {% endif %}
            {% else %}
              {% if current_temp < (target - effective_heating_hysteresis) %}
                {{ var_ff_heat_mode }}
              {% elif current_temp > (target + effective_cooling_hysteresis) %}
                {{ var_ff_cool_mode }}
              {% else %}
                {{ var_ff_comfort_mode }}
              {% endif %}
            {% endif %}
      alias: Determine 4th Floor HVAC Mode (if mode control enabled)
    - condition: template
      value_template: >
        {{ states(var_comfort_temperature_id) not in ['unknown', 'unavailable', 'none'] and
           states(var_second_floor_temp_sensor_id) not in ['unknown', 'unavailable', 'none'] and
           states(var_fourth_floor_temp_sensor_id) not in ['unknown', 'unavailable', 'none'] }}
      alias: "All sensors must be available before setting climate"
    - variables:
        sf_previous_mode: '{{ states(var_sf_hvac_mode_helper_id) }}'
        ff_previous_mode: '{{ states(var_ff_hvac_mode_helper_id) }}'
        sf_target_hvac_mode: '{% set mode = states(var_sf_hvac_mode_helper_id) %}{{ mode if mode not in ["unknown", "unavailable", "none", ""] else var_sf_comfort_mode }}'
        sf_target_preset: '{% if sf_target_hvac_mode == var_sf_heat_mode %}{{ var_sf_heat_preset }}{% elif sf_target_hvac_mode == var_sf_cool_mode %}{{ var_sf_cool_preset }}{% else %}{{ var_sf_comfort_preset }}{% endif %}'
        sf_target_temp: '{{ (states(var_comfort_temperature_id)|float(0) + var_second_floor_temp_diff) }}'
        ff_target_hvac_mode: '{% set mode = states(var_ff_hvac_mode_helper_id) %}{{ mode if mode not in ["unknown", "unavailable", "none", ""] else var_ff_comfort_mode }}'
        ff_target_preset: '{% if ff_target_hvac_mode == var_ff_heat_mode %}{{ var_ff_heat_preset }}{% elif ff_target_hvac_mode == var_ff_cool_mode %}{{ var_ff_cool_preset }}{% else %}{{ var_ff_comfort_preset }}{% endif %}'
        ff_target_temp: '{{ (states(var_comfort_temperature_id)|float(0) + var_fourth_floor_temp_diff) }}'
        sf_mode_changed: '{{ sf_previous_mode not in ["unknown", "unavailable", "none", ""] and sf_target_hvac_mode != sf_previous_mode }}'
        ff_mode_changed: '{{ ff_previous_mode not in ["unknown", "unavailable", "none", ""] and ff_target_hvac_mode != ff_previous_mode }}'
    - condition: template
      value_template: >
        {{ sf_target_temp | float(0) > 0 and
           ff_target_temp | float(0) > 0 and
           (not var_sf_mode_control or (sf_target_hvac_mode in ['auto', 'heat_cool', 'cool', 'heat', 'fan_only', 'off'] and sf_target_preset in ['Normal', 'Powerful', 'Quiet', 'off'])) and
           (not var_ff_mode_control or (ff_target_hvac_mode in ['auto', 'heat_cool', 'cool', 'heat', 'fan_only', 'off'] and ff_target_preset in ['Normal', 'Powerful', 'Quiet', 'off'])) }}
      alias: "Validate floor AC settings before applying"
    - parallel:
      - sequence:
        - if:
          - condition: template
            value_template: '{{ var_sf_mode_control }}'
          then:
          - service: climate.set_temperature
            target:
              entity_id: !input second_floor_ac
            data:
              temperature: '{{ sf_target_temp }}'
              hvac_mode: '{{ sf_target_hvac_mode }}'
          - delay:
              seconds: 2
          - service: climate.set_preset_mode
            target:
              entity_id: !input second_floor_ac
            data:
              preset_mode: '{{ sf_target_preset }}'
          - if:
            - condition: template
              value_template: '{{ var_notification_device != "" and sf_mode_changed }}'
            then:
            - device_id: !input notification_device
              domain: mobile_app
              type: notify
              title: "Smart AC - 2nd Floor"
              message: >
                Mode: {{ sf_target_hvac_mode }} | Temp: {{ sf_target_temp }}Â°C | Preset: {{ sf_target_preset }}{% if var_dynamic_hysteresis_enabled and var_weather_entity != '' %} | Hyst: {{ effective_heating_hysteresis|round(1) }}Â°C{% endif %}{% if sf_defrost_protection_active %} | Defrost Protection Active ({{ sf_outdoor_temp }}Â°C){% endif %}
              data:
                url: '{{ var_dashboard_url if var_dashboard_url != "" else "/lovelace" }}'
                clickAction: '{{ var_dashboard_url if var_dashboard_url != "" else "/lovelace" }}'
          else:
          - service: climate.set_temperature
            target:
              entity_id: !input second_floor_ac
            data:
              temperature: '{{ sf_target_temp }}'
      - sequence:
        - if:
          - condition: template
            value_template: '{{ var_ff_mode_control }}'
          then:
          - service: climate.set_temperature
            target:
              entity_id: !input fourth_floor_ac
            data:
              temperature: '{{ ff_target_temp }}'
              hvac_mode: '{{ ff_target_hvac_mode }}'
          - delay:
              seconds: 2
          - service: climate.set_preset_mode
            target:
              entity_id: !input fourth_floor_ac
            data:
              preset_mode: '{{ ff_target_preset }}'
          - if:
            - condition: template
              value_template: '{{ var_notification_device != "" and ff_mode_changed }}'
            then:
            - device_id: !input notification_device
              domain: mobile_app
              type: notify
              title: "Smart AC - 4th Floor"
              message: >
                Mode: {{ ff_target_hvac_mode }} | Temp: {{ ff_target_temp }}Â°C | Preset: {{ ff_target_preset }}{% if var_dynamic_hysteresis_enabled and var_weather_entity != '' %} | Hyst: {{ effective_heating_hysteresis|round(1) }}Â°C{% endif %}{% if ff_defrost_protection_active %} | Defrost Protection Active ({{ ff_outdoor_temp }}Â°C){% endif %}
              data:
                url: '{{ var_dashboard_url if var_dashboard_url != "" else "/lovelace" }}'
                clickAction: '{{ var_dashboard_url if var_dashboard_url != "" else "/lovelace" }}'
          else:
          - service: climate.set_temperature
            target:
              entity_id: !input fourth_floor_ac
            data:
              temperature: '{{ ff_target_temp }}'
    - parallel:
      - sequence:
        - condition: template
          value_template: '{{ bathroom_floor_heating_entity != "" and bathroom_floor_heating_entity not in ["none", "unknown", "unavailable"] }}'
          alias: "Check if bathroom floor heating is configured"
        - service: climate.set_temperature
          target:
            entity_id: !input bathroom_floor_heating
          data:
            temperature: '{{ (states(var_comfort_temperature_id)|float(0) + var_bathroom_floor_heating_offset)|int }}'
          alias: "Set Bathroom Floor Heating Temperature"
      - sequence:
        - condition: template
          value_template: '{{ first_floor_heating_entity != "" and first_floor_heating_entity not in ["none", "unknown", "unavailable"] }}'
          alias: "Check if first floor heating is configured"
        - service: climate.set_temperature
          target:
            entity_id: !input first_floor_heating
          data:
            temperature: '{{ (states(var_comfort_temperature_id)|float(0) + var_first_floor_heating_offset)|int }}'
          alias: "Set First Floor Heating Temperature"
      - sequence:
        - condition: template
          value_template: '{{ dining_room_heating_entity != "" and dining_room_heating_entity not in ["none", "unknown", "unavailable"] }}'
          alias: "Check if dining room heating is configured"
        - service: climate.set_temperature
          target:
            entity_id: !input dining_room_heating
          data:
            temperature: '{{ (states(var_comfort_temperature_id)|float(0) + var_dining_room_heating_offset) }}'
          alias: "Set Dining Room Heating Temperature"
